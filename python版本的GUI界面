import tkinter as tk
from tkinter import ttk
import serial
import time
import threading
from tkinter import scrolledtext

class Com():
    def __init__(self, master):
        self.master = master
        self.master.title("串口控制器")

        # 串口配置
        self.ser = None
        self.isTrue=False

        # 创建主输出框
        self.outputText = scrolledtext.ScrolledText(master, height=16, width=50)
        self.outputText.pack(side=tk.TOP, fill=tk.X, expand=True)

        # 创建串口选择框
        self.combobox = ttk.Combobox(master, values=["com1", "com2", "com3", "com4"], state="readonly")
        self.combobox.pack(side=tk.LEFT, fill=tk.X, expand=True)

        # 创建打开串口按钮
        self.open_button = tk.Button(master, text="打开", command=self.open_com)
        self.open_button.pack(side=tk.LEFT, padx=5)

        # 创建关闭串口按钮
        self.close_button = tk.Button(master, text="关闭", command=self.close_com)
        self.close_button.pack(side=tk.LEFT, padx=5)

        # 创建主输入框
        self.inputEntry = tk.Entry(master, width=20,)
        self.inputEntry.pack(side=tk.LEFT, fill=tk.X, expand=True)
        # 创建文本发送按钮
        self.send_button = tk.Button(master, text="发送", command=self.send_com)
        self.send_button.pack(side=tk.RIGHT, padx=5)

        self.thread = threading.Thread(target=self.reset_text)
        self.thread.start()  # 启动线程


    def open_com(self):
        self.ser = serial.Serial(self.combobox.get(), 9600, timeout=1)
        self.isTrue=True

    def close_com(self):
        self.ser.close()

    def send_com(self):
        data_to_send = self.inputEntry.get()  # 获取输入框中的内容
        data_to_send+="\n"
        self.ser.write(data_to_send.encode('utf-8'))  # 将字符串编码为字节并发送

    def reset_text(self):
        while True:
            if self.isTrue==True:
                break
            time.sleep(1)
        while True:
            response = self.ser.readline()
            text=response.decode('utf-8')
            if text!='':
                self.outputText.insert(tk.END,text)
                response=''
            time.sleep(1)


# 创建主窗口
root = tk.Tk()
app = Com(root)
# 启动事件循环
root.mainloop()
